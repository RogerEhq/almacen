{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS | Punto de Venta</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        /* BASE Y LAYOUT GENERAL */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #eef1f5; /* Fondo suave */
            color: #333;
        }

        .pos-container {
            display: flex;
            max-width: 1400px;
            height: 95vh; /* Ocupa casi toda la altura de la pantalla */
            margin: 2.5vh auto;
            background-color: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); /* Sombra profesional */
            border-radius: 16px;
            overflow: hidden;
        }

        .cart-area {
            width: 65%;
            padding: 30px 40px;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column; /* Habilita el layout vertical con flexbox */
        }

        /* ENCABEZADO Y SESIÓN */
        h1 {
            color: #1e40af; /* Azul oscuro corporativo */
            margin-top: 0;
            font-size: 2.2em;
            font-weight: 700;
        }

        /* Información de sesión y controles */
        .pos-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e6e9f5;
            padding-bottom: 15px;
            margin-bottom: 25px;
            font-size: 0.95em;
        }
        .pos-header-info p {
            margin: 0;
            padding: 0;
            border: none;
        }
        .pos-header-info span#cash-balance { font-weight: bold; color: #28a745; font-size: 1.1em; }

        /* Estilos para los botones/enlaces de la sesión */
        .session-controls a {
            color: #007bff;
            text-decoration: none;
            transition: color 0.2s;
            margin-left: 15px;
        }
        .session-controls a:hover { color: #0056b3; text-decoration: underline; }

        .session-controls button[type="submit"] {
            background: none;
            border: none;
            color: #dc3545; /* Rojo para acción de cierre/logout */
            cursor: pointer;
            padding: 0;
            font-family: inherit;
            font-size: 1em;
            text-decoration: underline;
            transition: color 0.2s;
            margin-left: 15px;
        }
        .session-controls button[type="submit"]:hover {
             color: #a71d2a;
        }


        /* BÚSQUEDA DE PRODUCTO (El Foco de la UX) */
        #product-search h2 {
            margin-top: 10px;
            color: #495057;
            font-size: 1.2em;
            font-weight: 500;
        }
        #sku-input {
            width: 90%; /* Ajustado al 90% para dejar espacio para la sombra */
            padding: 22px; /* Más grande para facilidad de uso */
            margin-bottom: 30px;
            border: 1px solid #ccc;
            border-radius: 10px;
            font-size: 1.6em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        #sku-input:focus {
            border-color: #1e40af; /* Azul de enfoque */
            box-shadow: 0 0 8px rgba(30, 64, 175, 0.4);
            outline: none;
            background-color: #fff;
        }


        /* TABLA DE CARRITO */
        #cart-section {
            flex-grow: 1; /* Permite que el carrito crezca para llenar el espacio */
            overflow-y: auto; /* Permite desplazamiento */
        }
        #cart-section h2 {
            margin-top: 0;
            color: #1e40af;
            font-size: 1.6em;
            margin-bottom: 15px;
        }
        .cart-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
        }
        .cart-table th, .cart-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .cart-table th {
            background-color: #eef2ff;
            color: #1e40af;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        .cart-table tbody tr:hover { background-color: #f6f8ff; }


        /* ÁREA DE TOTAL (Lo más importante) */
        #total-area {
            font-size: 3em; /* Muy grande */
            text-align: right;
            margin-top: 20px;
            padding: 20px 0;
            color: #28a745; /* Verde de éxito */
            font-weight: 700;
            border-top: 4px solid #28a745; /* Separador grueso */
            border-bottom: none; /* Asegurar que no tome el estilo de <p> */
        }


        /* CONTROLES DE PAGO (Checkout) */
        .checkout-controls {
            width: 35%;
            padding: 40px 30px;
            background-color: #f7f9fc;
            border-left: 1px solid #e0e0e0;
            border-radius: 0 16px 16px 0;
            display: flex;
            flex-direction: column; /* Habilita el layout vertical con flexbox */
        }

        /* Flexbox para empujar el botón al fondo de la columna */
        #checkout-form {
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* Permitir que el formulario crezca */
        }

        .checkout-controls h3 {
            color: #1e40af;
            border-bottom: 1px solid #cceeff;
            padding-bottom: 15px;
            margin-top: 0;
            font-size: 1.8em;
            font-weight: 600;
        }
        .checkout-controls h4 {
            color: #495057;
            margin-top: 30px;
            font-size: 1.2em;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .payment-select {
            margin-bottom: 40px;
        }
        .payment-select label {
            display: block;
            margin-bottom: 10px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1.2em;
            transition: background-color 0.2s, border-color 0.2s;
            cursor: pointer;
            text-align: left;
            background-color: #fff;
        }
        .payment-select label:hover {
            background-color: #f6f8ff;
            border-color: #007bff;
        }
        .payment-select input[type="radio"] {
            margin-right: 15px;
            transform: scale(1.2);
            accent-color: #1e40af;
        }

        /* BOTÓN FINALIZAR VENTA */
        .checkout-controls button[type="submit"] {
            width: 100%;
            padding: 25px; /* Más grande para ser un gran botón de acción */
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.7em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            text-transform: uppercase;
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.4);
            margin-top: auto; /* <---- Empuja el botón al fondo */
        }
        .checkout-controls button[type="submit"]:hover {
            background-color: #1e7e34;
            transform: translateY(-3px);
        }
        .checkout-controls button[type="submit"][disabled] {
            background-color: #adb5bd;
            cursor: not-allowed;
            opacity: 0.8;
            color: #6c757d;
            transform: none;
            box-shadow: none;
        }

        /* MENSAJE DE CONFIRMACIÓN */
        #confirmation-area {
            margin-top: 20px;
        }
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="pos-container">
    <div class="cart-area">
        <h1>Punto de Venta</h1>

        <div class="pos-header-info">
            <p>Vendedor: <b>{{ user.username }}</b>
                | Caja Abierta:
                {% if active_session %}
                    <span id="cash-balance">${{ active_session.starting_balance|floatformat:2 }}</span>
                {% else %}
                    <span style="color: red;">No activa</span>
                {% endif %}
            </p>
            <div class="session-controls">
                <a href="{% url 'close_session' %}" {% if not active_session %}style="pointer-events: none; color: gray;"{% endif %}>
                    Cerrar Caja
                </a>
                <form style="display:inline;" method="post" action="{% url 'logout' %}">
                    {% csrf_token %}
                    <button type="submit">
                        Cerrar Sesión
                    </button>
                </form>
            </div>
        </div>
        <div id="product-search">
            <h2>Escanear o Buscar Producto</h2>
            <input
                type="text"
                name="sku"
                placeholder="Introduce SKU y presiona Enter"
                autofocus
                hx-post="{% url 'add_product' %}"
                hx-trigger="keyup[key=='Enter']"
                hx-target="#cart-body"
                hx-swap="beforeend"
                value=""
                id="sku-input"
                data-hx-url="{% url 'add_product' %}"
                {% if not active_session %}disabled{% endif %}
            />
        </div>

        <div
            hx-post="{% url 'update_total' %}"
            hx-trigger="htmx:afterOnLoad from:#sku-input"
            hx-target="#total-area"
            hx-swap="outerHTML"
            style="display:none;"
        ></div>

        <div id="cart-section">
            <h2>Detalle de Venta</h2>
            <table class="cart-table">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Nombre</th>
                        <th>Precio Unitario</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody id="cart-body">
                    {% for item in cart_items %}
                        {% include 'pos/product_row.html' %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h3 id="total-area">Total: ${{ cart_total|floatformat:2 }}</h3>
    </div>

    <div class="checkout-controls">
        <h3>Finalizar Venta</h3>
        <form
            hx-post="{% url 'checkout' %}"
            hx-target="#confirmation-area"
            hx-swap="innerHTML"
            id="checkout-form"
        >
            {% csrf_token %}
            <h4>Método de Pago (HU #5):</h4>
            <div class="payment-select">
                <label>
                    <input type="radio" name="payment_method" value="cash" checked> Efectivo
                </label>
                <label>
                    <input type="radio" name="payment_method" value="card"> Tarjeta
                </label>
            </div>
            <button type="submit">Finalizar Venta</button>
        </form>
        <div id="confirmation-area"></div>
    </div>
</div>

<script>
    // Añadir el token CSRF a cada solicitud HTMX
    document.body.addEventListener('htmx:configRequest', function(event) {
        const token = document.querySelector('meta[name="csrf-token"]').content;
        if (token) {
            event.detail.headers['X-CSRFToken'] = token;
        }
    });

    // Limpiar y enfocar el campo SKU después de enviar
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        const skuInput = document.getElementById('sku-input');
        const expectedPath = skuInput.dataset.hxUrl;
        if (evt.detail.requestConfig.path === expectedPath) {
            skuInput.value = '';
            skuInput.focus();
        }
    });

    // Limpiar carrito visualmente después de venta
    document.body.addEventListener('htmx:afterOnLoad', function(evt) {
        if (evt.detail.target.id === 'confirmation-area') {
            document.getElementById('cart-body').innerHTML = '';
            document.getElementById('total-area').innerHTML = 'Total: $0.00';
        }
    });
</script>

</body>
</html>